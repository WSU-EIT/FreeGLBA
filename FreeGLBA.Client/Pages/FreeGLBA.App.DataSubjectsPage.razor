@* FreeGLBA.App.DataSubjectsPage.razor - List page for DataSubject *@
@page "/DataSubjects"
@page "/{TenantCode}/DataSubjects"
@implements IDisposable
@inject BlazorDataModel Model
@inject HttpClient Http

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    <div class="container-fluid">
        <div class="@Model.StickyMenuClass">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title mb-0">
                    <i class="fa-solid fa-users me-2"></i>Data Subjects
                </h1>
                <button class="btn btn-primary" @onclick="CreateNew">
                    <i class="fa-solid fa-plus me-1"></i>New Subject
                </button>
            </div>
        </div>

        @* About Data Subjects - Collapsible Help *@
        <div class="card shadow-sm mb-3 border-info">
            <div class="card-header bg-info bg-opacity-10 cursor-pointer py-2" @onclick="() => _helpExpanded = !_helpExpanded">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fa-solid fa-circle-info me-2 text-info"></i>
                        <strong>What are Data Subjects?</strong>
                        <span class="text-muted ms-2">— Individuals whose protected financial information is being tracked</span>
                    </span>
                    <i class="fa-solid @(_helpExpanded ? "fa-chevron-up" : "fa-chevron-down") text-info"></i>
                </div>
            </div>
            @if (_helpExpanded) {
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-info"><i class="fa-solid fa-user-shield me-1"></i>In GLBA Terms</h6>
                            <p class="small text-muted mb-0">
                                A <strong>Data Subject</strong> is any individual whose nonpublic personal information (NPI) 
                                is held by your institution. Under GLBA, you must protect their financial data and be able 
                                to report all access to their records upon request (e.g., for audits or data subject access requests).
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-info"><i class="fa-solid fa-list-ul me-1"></i>Examples</h6>
                            <ul class="small text-muted mb-0 ps-3">
                                <li>Students who applied for financial aid</li>
                                <li>Students with tuition payment plans</li>
                                <li>Alumni with outstanding balances</li>
                                <li>Parents who provided financial info (PLUS loans)</li>
                                <li>Employees with direct deposit/payroll data</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-info"><i class="fa-solid fa-gears me-1"></i>How It Works</h6>
                            <p class="small text-muted mb-0">
                                Data subjects are <strong>automatically created</strong> when access events reference them. 
                                The system tracks statistics like total access count, unique accessors, and first/last access dates. 
                                This enables quick auditing of all activity related to any individual.
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search by ID or type..."
                                   @bind="_filter.Search" @bind:event="oninput" @bind:after="LoadData" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" @bind="_filter.PageSize" @bind:after="@(() => { _filter.Page = 1; LoadData(); })">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @if (_loading) {
            <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
        } else if (_result.Records.Count == 0) {
            <div class="text-center py-5 text-muted">
                <i class="fa-solid fa-users fa-4x mb-3 opacity-50"></i>
                <h4>No data subjects found</h4>
                <p>Data subjects are automatically created when access events reference them.</p>
            </div>
        } else {
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable @SortClass("ExternalId")" @onclick="@(() => Sort("ExternalId"))">
                                    Subject ID <i class="fa-solid @SortIcon("ExternalId") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("SubjectType")" @onclick="@(() => Sort("SubjectType"))">
                                    Type <i class="fa-solid @SortIcon("SubjectType") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("TotalAccessCount")" @onclick="@(() => Sort("TotalAccessCount"))">
                                    Total Accesses <i class="fa-solid @SortIcon("TotalAccessCount") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("UniqueAccessorCount")" @onclick="@(() => Sort("UniqueAccessorCount"))">
                                    Unique Users <i class="fa-solid @SortIcon("UniqueAccessorCount") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("FirstAccessedAt")" @onclick="@(() => Sort("FirstAccessedAt"))">
                                    First Access <i class="fa-solid @SortIcon("FirstAccessedAt") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("LastAccessedAt")" @onclick="@(() => Sort("LastAccessedAt"))">
                                    Last Access <i class="fa-solid @SortIcon("LastAccessedAt") ms-1"></i>
                                </th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _result.Records) {
                                <tr>
                                    <td>
                                        <strong>@item.ExternalId</strong>
                                    </td>
                                    <td>
                                        @{
                                            var typeIcon = item.SubjectType?.ToLower() switch {
                                                "student" => "fa-user-graduate",
                                                "employee" => "fa-user-tie",
                                                "customer" => "fa-user",
                                                _ => "fa-user-circle"
                                            };
                                        }
                                        <i class="fa-solid @typeIcon me-1 text-muted"></i>
                                        @(string.IsNullOrEmpty(item.SubjectType) ? "Unknown" : item.SubjectType)
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@item.TotalAccessCount.ToString("N0")</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.UniqueAccessorCount.ToString("N0")</span>
                                    </td>
                                    <td>
                                        <span title="@item.FirstAccessedAt.ToString("f")">
                                            @item.FirstAccessedAt.ToString("MMM dd, yyyy")
                                        </span>
                                    </td>
                                    <td>
                                        <span title="@item.LastAccessedAt.ToString("f")">
                                            @GetRelativeTime(item.LastAccessedAt)
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="@(() => Edit(item))" title="View Details">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="@(() => ConfirmDelete(item))" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                @* Pagination *@
                @if (_result.TotalPages > 1) {
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="text-muted small">
                            Showing @((_filter.Page - 1) * _filter.PageSize + 1) - @Math.Min(_filter.Page * _filter.PageSize, _result.TotalRecords) of @_result.TotalRecords
                        </span>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item @(_filter.Page <= 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(1))" disabled="@(_filter.Page <= 1)">
                                        <i class="fa-solid fa-angles-left"></i>
                                    </button>
                                </li>
                                <li class="page-item @(_filter.Page <= 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_filter.Page - 1))" disabled="@(_filter.Page <= 1)">
                                        <i class="fa-solid fa-angle-left"></i>
                                    </button>
                                </li>
                                @foreach (var p in GetPageNumbers()) {
                                    <li class="page-item @(p == _filter.Page ? "active" : "")">
                                        <button class="page-link" @onclick="@(() => GoToPage(p))">@p</button>
                                    </li>
                                }
                                <li class="page-item @(_filter.Page >= _result.TotalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_filter.Page + 1))" disabled="@(_filter.Page >= _result.TotalPages)">
                                        <i class="fa-solid fa-angle-right"></i>
                                    </button>
                                </li>
                                <li class="page-item @(_filter.Page >= _result.TotalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_result.TotalPages))" disabled="@(_filter.Page >= _result.TotalPages)">
                                        <i class="fa-solid fa-angles-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        }
    </div>

    @if (_showEdit) {
        <FreeGLBA_App_EditDataSubject Item="_editItem" OnSave="SaveItem" OnCancel="CloseEdit" />
    }

    @* Delete Confirmation Modal *@
    @if (_showDeleteConfirm) {
        <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete subject <strong>@_deleteItem?.ExternalId</strong>?</p>
                        <p class="text-muted small">This will remove the subject statistics. Access events will be preserved.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteConfirmed">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

<style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: #e9ecef; }
    .sort-active { font-weight: bold; }
</style>

@code {
    [Parameter] public string? TenantCode { get; set; }
    
    private string _pageName = "datasubjects";
    private bool _loading = true;
    private DataObjects.DataSubjectFilter _filter = new() { SortColumn = "LastAccessedAt", SortDescending = true };
    private DataObjects.DataSubjectFilterResult _result = new();
    private bool _showEdit = false;
    private DataObjects.DataSubject _editItem = new();
    private bool _showDeleteConfirm = false;
    private DataObjects.DataSubject? _deleteItem = null;
    private bool _helpExpanded = false;

    public void Dispose() { Model.OnChange -= StateHasChanged; }

    protected override void OnInitialized() {
        Model.View = _pageName;
        Model.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) await LoadData();
    }

    private async Task LoadData() {
        _loading = true;
        StateHasChanged();
        _result = await Helpers.GetOrPost<DataObjects.DataSubjectFilterResult>(
            DataObjects.Endpoints.FreeGLBA.GetDataSubjects, _filter) ?? new();
        _loading = false;
        StateHasChanged();
    }

    private void Sort(string column) {
        if (_filter.SortColumn == column) {
            _filter.SortDescending = !_filter.SortDescending;
        } else {
            _filter.SortColumn = column;
            _filter.SortDescending = column == "TotalAccessCount" || column == "UniqueAccessorCount" || 
                                     column == "LastAccessedAt" || column == "FirstAccessedAt";
        }
        _filter.Page = 1;
        _ = LoadData();
    }

    private string SortClass(string column) => _filter.SortColumn == column ? "sort-active" : "";
    private string SortIcon(string column) {
        if (_filter.SortColumn != column) return "fa-sort text-muted";
        return _filter.SortDescending ? "fa-sort-down" : "fa-sort-up";
    }

    private async Task GoToPage(int page) {
        _filter.Page = page;
        await LoadData();
    }

    private IEnumerable<int> GetPageNumbers() {
        var start = Math.Max(1, _filter.Page - 2);
        var end = Math.Min(_result.TotalPages, _filter.Page + 2);
        return Enumerable.Range(start, end - start + 1);
    }

    private string GetRelativeTime(DateTime dt) {
        var diff = DateTime.UtcNow - dt;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return dt.ToString("MMM dd, yyyy");
    }

    private void CreateNew() { _editItem = new DataObjects.DataSubject(); _showEdit = true; }
    private void Edit(DataObjects.DataSubject item) { _editItem = item; _showEdit = true; }
    private void CloseEdit() { _showEdit = false; }

    private async Task SaveItem(DataObjects.DataSubject item) {
        await Helpers.GetOrPost<DataObjects.DataSubject>(DataObjects.Endpoints.FreeGLBA.SaveDataSubject, item);
        _showEdit = false;
        await LoadData();
    }

    private void ConfirmDelete(DataObjects.DataSubject item) { _deleteItem = item; _showDeleteConfirm = true; }
    private void CancelDelete() { _deleteItem = null; _showDeleteConfirm = false; }

    private async Task DeleteConfirmed() {
        if (_deleteItem != null) {
            await Helpers.GetOrPost<bool>(DataObjects.Endpoints.FreeGLBA.DeleteDataSubject, _deleteItem.DataSubjectId);
            _deleteItem = null;
            _showDeleteConfirm = false;
            await LoadData();
        }
    }
}
