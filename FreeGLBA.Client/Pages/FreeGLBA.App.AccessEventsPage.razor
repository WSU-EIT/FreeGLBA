@* FreeGLBA.App.AccessEventsPage.razor - List page for AccessEvent *@
@page "/AccessEvents"
@page "/{TenantCode}/AccessEvents"
@implements IDisposable
@inject BlazorDataModel Model
@inject HttpClient Http

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    <div class="container-fluid">
        <div class="@Model.StickyMenuClass">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title mb-0">
                    <i class="fa-solid fa-list-check me-2"></i>Access Events
                </h1>
                <button class="btn btn-primary" @onclick="CreateNew">
                    <i class="fa-solid fa-plus me-1"></i>New Event
                </button>
            </div>
        </div>

        @* About Access Events - Collapsible Help *@
        <div class="card shadow-sm mb-3 border-info">
            <div class="card-header bg-info bg-opacity-10 cursor-pointer py-2" @onclick="() => _helpExpanded = !_helpExpanded">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fa-solid fa-circle-info me-2 text-info"></i>
                        <strong>What are Access Events?</strong>
                        <span class="text-muted ms-2">— Records of who accessed protected financial data, when, and why</span>
                    </span>
                    <i class="fa-solid @(_helpExpanded ? "fa-chevron-up" : "fa-chevron-down") text-info"></i>
                </div>
            </div>
            @if (_helpExpanded) {
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-md-3">
                            <h6 class="text-info"><i class="fa-solid fa-scale-balanced me-1"></i>In GLBA Terms</h6>
                            <p class="small text-muted mb-0">
                                An <strong>Access Event</strong> records each instance when an employee or system accesses 
                                a customer's nonpublic personal information (NPI). GLBA requires institutions to maintain 
                                logs showing who accessed what data, when, and for what legitimate business purpose.
                            </p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-info"><i class="fa-solid fa-list-ul me-1"></i>Examples</h6>
                            <ul class="small text-muted mb-0 ps-3">
                                <li>Financial aid advisor views student's FAFSA data</li>
                                <li>Bursar staff accesses account balance</li>
                                <li>Registrar exports student financial records</li>
                                <li>IT admin runs report on payment history</li>
                                <li>Automated system processes loan disbursement</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-info"><i class="fa-solid fa-database me-1"></i>Key Fields</h6>
                            <ul class="small text-muted mb-0 ps-3">
                                <li><strong>User</strong> — Who accessed the data</li>
                                <li><strong>Subject</strong> — Whose data was accessed</li>
                                <li><strong>Access Type</strong> — View, export, modify</li>
                                <li><strong>Purpose</strong> — Business reason</li>
                                <li><strong>Data Category</strong> — Type of data</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-info"><i class="fa-solid fa-file-signature me-1"></i>Agreement Tracking</h6>
                            <p class="small text-muted mb-0">
                                Each event can include a copy of the <strong>privacy notice/agreement</strong> the user 
                                acknowledged before accessing data. This documents exactly what disclosure was shown 
                                at the time of access — critical for GLBA compliance audits.
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search by user, subject, purpose..."
                                   @bind="_filter.Search" @bind:event="oninput" @bind:after="LoadData" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" @bind="_filter.PageSize" @bind:after="@(() => { _filter.Page = 1; LoadData(); })">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" @bind="_sourceSystemFilter" @bind:after="@(() => { _filter.Page = 1; LoadData(); })">
                            <option value="">All Source Systems</option>
                            @foreach (var source in _sourceSystems) {
                                <option value="@source.SourceSystemId">@source.DisplayName</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @if (_loading) {
            <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
        } else if (_result.Records.Count == 0) {
            <div class="text-center py-5 text-muted">
                <i class="fa-solid fa-inbox fa-4x mb-3 opacity-50"></i>
                <h4>No access events found</h4>
                <p>Events will appear here when external systems send data.</p>
            </div>
        } else {
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable @SortClass("SourceSystemName")" @onclick="@(() => Sort("SourceSystemName"))">
                                    Source System <i class="fa-solid @SortIcon("SourceSystemName") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("AccessedAt")" @onclick="@(() => Sort("AccessedAt"))">
                                    Accessed <i class="fa-solid @SortIcon("AccessedAt") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("UserId")" @onclick="@(() => Sort("UserId"))">
                                    User <i class="fa-solid @SortIcon("UserId") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("SubjectId")" @onclick="@(() => Sort("SubjectId"))">
                                    Subject <i class="fa-solid @SortIcon("SubjectId") ms-1"></i>
                                </th>
                                <th class="sortable @SortClass("AccessType")" @onclick="@(() => Sort("AccessType"))">
                                    Type <i class="fa-solid @SortIcon("AccessType") ms-1"></i>
                                </th>
                                <th>Purpose</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _result.Records) {
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">@(string.IsNullOrEmpty(item.SourceSystemName) ? "Unknown" : item.SourceSystemName)</span>
                                    </td>
                                    <td>
                                        <span title="@item.AccessedAt.ToLocalTime().ToString("f")">@item.AccessedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</span>
                                    </td>
                                    <td>
                                        <div>@item.UserId</div>
                                        @if (!string.IsNullOrEmpty(item.UserName)) {
                                            <small class="text-muted">@item.UserName</small>
                                        }
                                    </td>
                                    <td>
                                        @if (item.SubjectCount > 1) {
                                            <span class="badge bg-warning text-dark">@item.SubjectCount subjects</span>
                                        } else {
                                            <div>@item.SubjectId</div>
                                            @if (!string.IsNullOrEmpty(item.SubjectType)) {
                                                <small class="text-muted">@item.SubjectType</small>
                                            }
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var typeClass = item.AccessType?.ToLower() switch {
                                                "export" => "bg-warning text-dark",
                                                "view" => "bg-info",
                                                "print" => "bg-secondary",
                                                "delete" => "bg-danger",
                                                _ => "bg-primary"
                                            };
                                        }
                                        <span class="badge @typeClass">@(string.IsNullOrEmpty(item.AccessType) ? "N/A" : item.AccessType)</span>
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="@item.Purpose">
                                            @(string.IsNullOrEmpty(item.Purpose) ? "-" : item.Purpose)
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="@(() => Edit(item))" title="View/Edit">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="@(() => ConfirmDelete(item))" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                @* Pagination *@
                @if (_result.TotalPages > 1) {
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="text-muted small">
                            Showing @((_filter.Page - 1) * _filter.PageSize + 1) - @Math.Min(_filter.Page * _filter.PageSize, _result.TotalRecords) of @_result.TotalRecords
                        </span>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item @(_filter.Page <= 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(1))" disabled="@(_filter.Page <= 1)">
                                        <i class="fa-solid fa-angles-left"></i>
                                    </button>
                                </li>
                                <li class="page-item @(_filter.Page <= 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_filter.Page - 1))" disabled="@(_filter.Page <= 1)">
                                        <i class="fa-solid fa-angle-left"></i>
                                    </button>
                                </li>
                                @foreach (var p in GetPageNumbers()) {
                                    <li class="page-item @(p == _filter.Page ? "active" : "")">
                                        <button class="page-link" @onclick="@(() => GoToPage(p))">@p</button>
                                    </li>
                                }
                                <li class="page-item @(_filter.Page >= _result.TotalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_filter.Page + 1))" disabled="@(_filter.Page >= _result.TotalPages)">
                                        <i class="fa-solid fa-angle-right"></i>
                                    </button>
                                </li>
                                <li class="page-item @(_filter.Page >= _result.TotalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="@(() => GoToPage(_result.TotalPages))" disabled="@(_filter.Page >= _result.TotalPages)">
                                        <i class="fa-solid fa-angles-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        }
    </div>

    @if (_showEdit) {
        <FreeGLBA_App_EditAccessEvent Item="_editItem" OnSave="SaveItem" OnCancel="CloseEdit" />
    }

    @* Delete Confirmation Modal *@
    @if (_showDeleteConfirm) {
        <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this access event?</p>
                        <p class="text-muted small">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteConfirmed">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

<style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: #e9ecef; }
    .sort-active { font-weight: bold; }
</style>

@code {
    [Parameter] public string? TenantCode { get; set; }

    private string _pageName = "accessevents";
    private bool _loading = true;
    private DataObjects.AccessEventFilter _filter = new() { SortColumn = "AccessedAt", SortDescending = true };
    private DataObjects.AccessEventFilterResult _result = new();
    private List<DataObjects.SourceSystem> _sourceSystems = new();
    private string _sourceSystemFilter = "";
    private bool _showEdit = false;
    private DataObjects.AccessEvent _editItem = new();
    private bool _showDeleteConfirm = false;
    private DataObjects.AccessEvent? _deleteItem = null;
    private bool _helpExpanded = false;

    public void Dispose() { Model.OnChange -= StateHasChanged; }

    protected override void OnInitialized() {
        Model.View = _pageName;
        Model.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            await LoadSourceSystems();
            await LoadData();
        }
    }

    private async Task LoadSourceSystems() {
        _sourceSystems = await Helpers.GetOrPost<List<DataObjects.SourceSystem>>(
            DataObjects.Endpoints.FreeGLBA.GetSourceSystems, null) ?? new();
    }

    private async Task LoadData() {
        _loading = true;
        StateHasChanged();
        
        if (!string.IsNullOrEmpty(_sourceSystemFilter) && Guid.TryParse(_sourceSystemFilter, out var sourceId)) {
            _filter.SourceSystemIdFilter = sourceId;
        } else {
            _filter.SourceSystemIdFilter = Guid.Empty;
        }
        
        _result = await Helpers.GetOrPost<DataObjects.AccessEventFilterResult>(
            DataObjects.Endpoints.FreeGLBA.GetAccessEvents, _filter) ?? new();
        _loading = false;
        StateHasChanged();
    }

    private void Sort(string column) {
        if (_filter.SortColumn == column) {
            _filter.SortDescending = !_filter.SortDescending;
        } else {
            _filter.SortColumn = column;
            _filter.SortDescending = true;
        }
        _filter.Page = 1;
        _ = LoadData();
    }

    private string SortClass(string column) => _filter.SortColumn == column ? "sort-active" : "";
    private string SortIcon(string column) {
        if (_filter.SortColumn != column) return "fa-sort text-muted";
        return _filter.SortDescending ? "fa-sort-down" : "fa-sort-up";
    }

    private async Task GoToPage(int page) {
        _filter.Page = page;
        await LoadData();
    }

    private IEnumerable<int> GetPageNumbers() {
        var start = Math.Max(1, _filter.Page - 2);
        var end = Math.Min(_result.TotalPages, _filter.Page + 2);
        return Enumerable.Range(start, end - start + 1);
    }

    private void CreateNew() { _editItem = new DataObjects.AccessEvent(); _showEdit = true; }
    private void Edit(DataObjects.AccessEvent item) { _editItem = item; _showEdit = true; }
    private void CloseEdit() { _showEdit = false; }

    private async Task SaveItem(DataObjects.AccessEvent item) {
        await Helpers.GetOrPost<DataObjects.AccessEvent>(DataObjects.Endpoints.FreeGLBA.SaveAccessEvent, item);
        _showEdit = false;
        await LoadData();
    }

    private void ConfirmDelete(DataObjects.AccessEvent item) { _deleteItem = item; _showDeleteConfirm = true; }
    private void CancelDelete() { _showDeleteConfirm = false; _deleteItem = null; }

    private async Task DeleteConfirmed() {
        if (_deleteItem != null) {
            await Helpers.GetOrPost<bool>(DataObjects.Endpoints.FreeGLBA.DeleteAccessEvent, _deleteItem.AccessEventId);
            _showDeleteConfirm = false;
            _deleteItem = null;
            await LoadData();
        }
    }
}
