@* FreeGLBA.App.EditAccessEvent.razor - Edit/Create form for AccessEvent *@
@inject HttpClient Http
@inject BlazorDataModel Model

<div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid @(IsNew ? "fa-plus" : "fa-pen") me-2"></i>
                    @(IsNew ? "New" : "Edit") Access Event
                </h5>
                <button type="button" class="btn-close" @onclick="Cancel" disabled="@_saving"></button>
            </div>
            <div class="modal-body">
                @if (_loading) {
                    <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
                } else {
                    @if (IsNew) {
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GenerateTestData" disabled="@(_sourcesystemList.Count == 0)">
                                <i class="fa-solid fa-wand-magic-sparkles me-1"></i>Generate Test Data
                            </button>
                            @if (_sourcesystemList.Count == 0) {
                                <span class="text-muted small ms-2">Create a Source System first</span>
                            }
                        </div>
                    }
                    <EditForm Model="Item" OnValidSubmit="Save">
                        <DataAnnotationsValidator />
                        
                        <h6 class="text-muted mb-3">Source Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source System <span class="text-danger">*</span></label>
                                <select id="edit-accessevent-SourceSystemId" class="form-select @Helpers.MissingValue(Item.SourceSystemId != Guid.Empty ? "x" : "")" 
                                        @bind="Item.SourceSystemId">
                                    <option value="@Guid.Empty">-- Select Source System --</option>
                                    @foreach (var parent in _sourcesystemList) {
                                        <option value="@parent.SourceSystemId">@parent.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Event ID</label>
                                <input type="text" class="form-control" @bind="Item.SourceEventId" placeholder="External system's event ID (for deduplication)" />
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Access Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Accessed At <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" @bind="Item.AccessedAt" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Access Type <span class="text-danger">*</span></label>
                                <input type="text" class="form-control @Helpers.MissingValue(Item.AccessType)" list="accessTypeList" 
                                       @bind="Item.AccessType" placeholder="e.g., View, Export, Print" />
                                <datalist id="accessTypeList">
                                    <option value="View" />
                                    <option value="Export" />
                                    <option value="Print" />
                                    <option value="Modify" />
                                    <option value="Delete" />
                                    <option value="Query" />
                                    <option value="Download" />
                                    <option value="API Access" />
                                </datalist>
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Accessor Information (Who Accessed)</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control @Helpers.MissingValue(Item.UserId)" @bind="Item.UserId" placeholder="Employee/User ID" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Name</label>
                                <input type="text" class="form-control" @bind="Item.UserName" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Email</label>
                                <input type="email" class="form-control" @bind="Item.UserEmail" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Department</label>
                                <input type="text" class="form-control" @bind="Item.UserDepartment" />
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Subject Information (Whose Data Was Accessed)</h6>
                        
                        @* Bulk vs Single Access Toggle *@
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="accessMode" id="singleAccess" 
                                       checked="@(!_bulkAccessMode)" @onchange="() => SetAccessMode(false)" />
                                <label class="form-check-label" for="singleAccess">Single Subject</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="accessMode" id="bulkAccess" 
                                       checked="@_bulkAccessMode" @onchange="() => SetAccessMode(true)" />
                                <label class="form-check-label" for="bulkAccess">Bulk Access (CSV Export, etc.)</label>
                            </div>
                        </div>

                        @if (!_bulkAccessMode) {
                            @* Single Subject Mode *@
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Subject ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control @Helpers.MissingValue(Item.SubjectId)" @bind="Item.SubjectId" placeholder="ID of person whose data was accessed" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Subject Type</label>
                                    <input type="text" class="form-control" list="subjectTypeList" @bind="Item.SubjectType" placeholder="e.g., Student, Employee" />
                                    <datalist id="subjectTypeList">
                                        <option value="Student" />
                                        <option value="Employee" />
                                        <option value="Customer" />
                                        <option value="Applicant" />
                                        <option value="Vendor" />
                                        <option value="Patient" />
                                        <option value="Member" />
                                    </datalist>
                                </div>
                            </div>
                        } else {
                            @* Bulk Access Mode *@
                            <div class="alert alert-info py-2 mb-3">
                                <i class="fa-solid fa-info-circle me-1"></i>
                                <strong>Bulk Access:</strong> Enter subject IDs separated by commas, spaces, or newlines. 
                                Each subject will be tracked individually in the Data Subjects table.
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Subject IDs <span class="text-danger">*</span> <span class="badge bg-secondary">@_parsedSubjectCount subjects</span></label>
                                    <textarea class="form-control font-monospace" rows="4" @bind="_bulkSubjectIdsText" @bind:event="oninput" @bind:after="ParseBulkSubjectIds"
                                              placeholder="S12345678&#10;S23456789&#10;S34567890&#10;...or paste comma-separated: S12345678, S23456789, S34567890"></textarea>
                                    <div class="form-text">Paste subject IDs from your export. Duplicates will be removed automatically.</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Subject Type</label>
                                    <input type="text" class="form-control" list="subjectTypeList" @bind="Item.SubjectType" placeholder="e.g., Student" />
                                    <datalist id="subjectTypeList">
                                        <option value="Student" />
                                        <option value="Employee" />
                                        <option value="Customer" />
                                        <option value="Applicant" />
                                    </datalist>
                                </div>
                            </div>
                        }

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data Category</label>
                                <input type="text" class="form-control" list="dataCategoryList" @bind="Item.DataCategory" placeholder="e.g., Financial, Personal Info" />
                                <datalist id="dataCategoryList">
                                    <option value="Financial Aid" />
                                    <option value="Financial Records" />
                                    <option value="Personal Info" />
                                    <option value="Tax Info" />
                                    <option value="SSN" />
                                    <option value="Health Records" />
                                    <option value="Academic Records" />
                                    <option value="Employment Records" />
                                    <option value="Contact Info" />
                                    <option value="Payment Info" />
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">IP Address</label>
                                <input type="text" class="form-control" @bind="Item.IpAddress" placeholder="e.g., 192.168.1.1" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Purpose / Business Justification</label>
                            <textarea class="form-control" rows="2" @bind="Item.Purpose" placeholder="Reason for accessing this data"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Additional Data (JSON)</label>
                            <textarea class="form-control font-monospace" rows="2" @bind="Item.AdditionalData" placeholder='{"customField": "value"}'></textarea>
                            <div class="form-text">Use this field for any system-specific data not covered above.</div>
                        </div>

                        <hr />
                        <h6 class="text-primary"><i class="fa-solid fa-file-signature me-1"></i>Privacy Agreement</h6>
                        <div class="mb-3">
                            <label class="form-label">Agreement Text</label>
                            <textarea class="form-control" rows="3" @bind="Item.AgreementText" placeholder="Copy of the privacy notice/agreement shown to the user at time of access"></textarea>
                            <div class="form-text">Capture the exact disclosure text the user acknowledged before accessing this data (required for GLBA compliance audits).</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Agreement Acknowledged At</label>
                            <input type="datetime-local" class="form-control" @bind="Item.AgreementAcknowledgedAt" />
                            <div class="form-text">When the user acknowledged the privacy agreement. Defaults to access time if not specified.</div>
                        </div>

                        @if (!IsNew) {
                            <hr />
                            <div class="row text-muted small">
                                <div class="col-md-6">
                                    <strong>Received At:</strong> @Item.ReceivedAt.ToString("MMM dd, yyyy h:mm tt")
                                </div>
                            </div>
                        }
                    </EditForm>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@_saving">
                    @Helpers.ConfirmButtonTextCancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="Save" disabled="@(_saving || _loading)">
                    @if (_saving) {
                        <i class="fa-solid fa-spinner fa-spin me-1"></i>
                        <span>Saving...</span>
                    } else {
                        <i class="fa-solid fa-save me-1"></i>
                        <span>Save</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public DataObjects.AccessEvent Item { get; set; } = new();
    [Parameter] public EventCallback<DataObjects.AccessEvent> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // Test data arrays
    private static readonly string[] _firstNames = { "James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda", "David", "Elizabeth", "William", "Barbara", "Richard", "Susan", "Joseph", "Jessica", "Thomas", "Sarah", "Charles", "Karen" };
    private static readonly string[] _lastNames = { "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin" };
    private static readonly string[] _departments = { "Financial Aid", "Bursar", "Registrar", "Admissions", "Student Accounts", "Academic Advising", "IT Services", "Business Office", "Enrollment Services", "Records" };
    private static readonly string[] _accessTypes = { "View", "Export", "Print", "Query", "Download", "API Access" };
    private static readonly string[] _dataCategories = { "Financial Aid", "Financial Records", "Tax Info", "Payment History", "Account Balance", "Loan Info", "Scholarship Data", "FAFSA Data", "Direct Deposit", "1098-T" };
    private static readonly string[] _subjectTypes = { "Student", "Student", "Student", "Student", "Employee", "Applicant" }; // Weighted toward Student
    private static readonly string[] _purposes = { "Enrollment verification", "Aid disbursement review", "Account inquiry", "Payment processing", "Audit request", "Student inquiry", "Compliance check", "Report generation", "Data verification", "Annual review" };
    private static readonly string[] _agreementTemplates = {
        "I acknowledge that I am accessing protected financial information in accordance with GLBA requirements and institutional policy. I will only use this data for legitimate business purposes.",
        "By accessing this record, I confirm I have a valid business need and will protect this information per FERPA and GLBA regulations.",
        "I certify that I require access to this financial data for official university business and will maintain confidentiality as required by federal law.",
    };
    private static readonly Random _random = new();

    private List<DataObjects.SourceSystem> _sourcesystemList = new();
    private bool IsNew => Item.AccessEventId == default;
    private bool _loading = true;
    private bool _saving = false;

    private bool _bulkAccessMode = false;
    private string _bulkSubjectIdsText = "";
    private int _parsedSubjectCount = 0;

    protected override async Task OnInitializedAsync() {
        var sourcesystemResult = await Helpers.GetOrPost<DataObjects.SourceSystemFilterResult>(
            DataObjects.Endpoints.FreeGLBA.GetSourceSystems, new DataObjects.SourceSystemFilter { PageSize = 1000 }) ?? new();
        _sourcesystemList = sourcesystemResult.Records;
        _loading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender && !_loading) {
            await Helpers.DelayedFocus("edit-accessevent-SourceSystemId");
        }
    }

    protected override void OnParametersSet() {
        // Set defaults for new records
        if (IsNew) {
            Item.AccessedAt = DateTime.Now;
        }
    }

    private void GenerateTestData() {
        if (_sourcesystemList.Count == 0) return;

        // Pick a random source system
        var source = _sourcesystemList[_random.Next(_sourcesystemList.Count)];
        Item.SourceSystemId = source.SourceSystemId;
        Item.SourceEventId = $"EVT-{DateTime.Now:yyyyMMdd}-{_random.Next(10000, 99999)}";

        // Generate accessor (employee) info
        var accessorFirst = _firstNames[_random.Next(_firstNames.Length)];
        var accessorLast = _lastNames[_random.Next(_lastNames.Length)];
        var empId = _random.Next(100000, 999999);
        Item.UserId = $"E{empId}";
        Item.UserName = $"{accessorFirst} {accessorLast}";
        Item.UserEmail = $"{accessorFirst.ToLower()}.{accessorLast.ToLower()}@university.edu";
        Item.UserDepartment = _departments[_random.Next(_departments.Length)];

        // Generate subject (student/person whose data was accessed) info
        var subjectFirst = _firstNames[_random.Next(_firstNames.Length)];
        var subjectLast = _lastNames[_random.Next(_lastNames.Length)];
        var studentId = _random.Next(10000000, 99999999);
        Item.SubjectId = $"S{studentId}";
        Item.SubjectType = _subjectTypes[_random.Next(_subjectTypes.Length)];

        // Access details
        Item.AccessedAt = DateTime.Now.AddMinutes(-_random.Next(0, 60)); // Within last hour
        Item.AccessType = _accessTypes[_random.Next(_accessTypes.Length)];
        Item.DataCategory = _dataCategories[_random.Next(_dataCategories.Length)];
        Item.Purpose = _purposes[_random.Next(_purposes.Length)];
        Item.IpAddress = $"10.{_random.Next(1, 255)}.{_random.Next(1, 255)}.{_random.Next(1, 255)}";

        // Agreement tracking
        Item.AgreementText = _agreementTemplates[_random.Next(_agreementTemplates.Length)];
        Item.AgreementAcknowledgedAt = Item.AccessedAt.AddSeconds(-_random.Next(5, 30)); // Acknowledged just before access

        StateHasChanged();
    }

    private void SetAccessMode(bool bulk) {
        _bulkAccessMode = bulk;

        if (!bulk) {
            // Clear bulk data when switching to single mode
            _bulkSubjectIdsText = "";
            _parsedSubjectCount = 0;
            Item.SubjectIds = "";
            Item.SubjectCount = 1;
        } else {
            // Clear single subject when switching to bulk mode
            Item.SubjectId = "";
        }
        StateHasChanged();
    }

    private void ParseBulkSubjectIds() {
        // Split input by commas, spaces, tabs, or newlines, and trim each ID
        var rawIds = _bulkSubjectIdsText
            .Split(new[] { ',', ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(id => id.Trim())
            .Where(id => !string.IsNullOrEmpty(id))
            .ToList();

        // Remove duplicates
        var uniqueIds = rawIds.Distinct().ToList();

        _parsedSubjectCount = uniqueIds.Count;

        if (_parsedSubjectCount > 0) {
            // Store as JSON array in SubjectIds
            Item.SubjectIds = System.Text.Json.JsonSerializer.Serialize(uniqueIds);
            Item.SubjectCount = _parsedSubjectCount;
            // Set SubjectId to "BULK" or first ID for display purposes
            Item.SubjectId = _parsedSubjectCount > 1 ? "BULK" : uniqueIds[0];
        } else {
            Item.SubjectIds = "";
            Item.SubjectCount = 1;
            Item.SubjectId = "";
        }
    }

    private async Task Save() {
        // Validation
        var errors = new List<string>();
        var focus = "";

        if (Item.SourceSystemId == Guid.Empty) {
            errors.Add(Helpers.MissingRequiredField("Source System"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-SourceSystemId";
        }
        if (string.IsNullOrWhiteSpace(Item.UserId)) {
            errors.Add(Helpers.MissingRequiredField("User ID"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-UserId";
        }
        
        // Validate subject - either single SubjectId or bulk SubjectIds
        if (_bulkAccessMode) {
            if (_parsedSubjectCount == 0) {
                errors.Add(Helpers.MissingRequiredField("Subject IDs"));
            }
        } else {
            if (string.IsNullOrWhiteSpace(Item.SubjectId)) {
                errors.Add(Helpers.MissingRequiredField("Subject ID"));
                if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-SubjectId";
            }
        }
        
        if (string.IsNullOrWhiteSpace(Item.AccessType)) {
            errors.Add(Helpers.MissingRequiredField("Access Type"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-AccessType";
        }

        if (errors.Any()) {
            Model.ErrorMessages(errors);
            await Helpers.DelayedFocus(focus);
            return;
        }

        _saving = true;
        Model.Message_Saving();
        StateHasChanged();

        try {
            await OnSave.InvokeAsync(Item);
            Model.ClearMessages();
            var msg = _bulkAccessMode ? $"Event saved with {_parsedSubjectCount} subjects!" : "";
            Model.Message_Saved(msg);
        } finally {
            _saving = false;
            StateHasChanged();
        }
    }

    private async Task Cancel() {
        if (!_saving) {
            await OnCancel.InvokeAsync();
        }
    }
}
