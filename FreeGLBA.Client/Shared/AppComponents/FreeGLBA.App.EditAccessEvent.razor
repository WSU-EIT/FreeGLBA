@* FreeGLBA.App.EditAccessEvent.razor - Edit/Create form for AccessEvent *@
@inject HttpClient Http
@inject BlazorDataModel Model

<div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid @(IsNew ? "fa-plus" : "fa-pen") me-2"></i>
                    @(IsNew ? "New" : "Edit") Access Event
                </h5>
                <button type="button" class="btn-close" @onclick="Cancel" disabled="@_saving"></button>
            </div>
            <div class="modal-body">
                @if (_loading) {
                    <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
                } else {
                    <EditForm Model="Item" OnValidSubmit="Save">
                        <DataAnnotationsValidator />
                        
                        <h6 class="text-muted mb-3">Source Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source System <span class="text-danger">*</span></label>
                                <select id="edit-accessevent-SourceSystemId" class="form-select @Helpers.MissingValue(Item.SourceSystemId != Guid.Empty ? "x" : "")" 
                                        @bind="Item.SourceSystemId">
                                    <option value="@Guid.Empty">-- Select Source System --</option>
                                    @foreach (var parent in _sourcesystemList) {
                                        <option value="@parent.SourceSystemId">@parent.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Event ID</label>
                                <input type="text" class="form-control" @bind="Item.SourceEventId" placeholder="External system's event ID (for deduplication)" />
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Access Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Accessed At <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" @bind="Item.AccessedAt" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Access Type <span class="text-danger">*</span></label>
                                <input type="text" class="form-control @Helpers.MissingValue(Item.AccessType)" list="accessTypeList" 
                                       @bind="Item.AccessType" placeholder="e.g., View, Export, Print" />
                                <datalist id="accessTypeList">
                                    <option value="View" />
                                    <option value="Export" />
                                    <option value="Print" />
                                    <option value="Modify" />
                                    <option value="Delete" />
                                    <option value="Query" />
                                    <option value="Download" />
                                    <option value="API Access" />
                                </datalist>
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Accessor Information (Who Accessed)</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control @Helpers.MissingValue(Item.UserId)" @bind="Item.UserId" placeholder="Employee/User ID" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Name</label>
                                <input type="text" class="form-control" @bind="Item.UserName" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Email</label>
                                <input type="email" class="form-control" @bind="Item.UserEmail" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">User Department</label>
                                <input type="text" class="form-control" @bind="Item.UserDepartment" />
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">Subject Information (Whose Data Was Accessed)</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subject ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control @Helpers.MissingValue(Item.SubjectId)" @bind="Item.SubjectId" placeholder="ID of person whose data was accessed" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subject Type</label>
                                <input type="text" class="form-control" list="subjectTypeList" @bind="Item.SubjectType" placeholder="e.g., Student, Employee" />
                                <datalist id="subjectTypeList">
                                    <option value="Student" />
                                    <option value="Employee" />
                                    <option value="Customer" />
                                    <option value="Applicant" />
                                    <option value="Vendor" />
                                    <option value="Patient" />
                                    <option value="Member" />
                                </datalist>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data Category</label>
                                <input type="text" class="form-control" list="dataCategoryList" @bind="Item.DataCategory" placeholder="e.g., Financial, Personal Info" />
                                <datalist id="dataCategoryList">
                                    <option value="Financial Aid" />
                                    <option value="Financial Records" />
                                    <option value="Personal Info" />
                                    <option value="Tax Info" />
                                    <option value="SSN" />
                                    <option value="Health Records" />
                                    <option value="Academic Records" />
                                    <option value="Employment Records" />
                                    <option value="Contact Info" />
                                    <option value="Payment Info" />
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">IP Address</label>
                                <input type="text" class="form-control" @bind="Item.IpAddress" placeholder="e.g., 192.168.1.1" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Purpose / Business Justification</label>
                            <textarea class="form-control" rows="2" @bind="Item.Purpose" placeholder="Reason for accessing this data"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Additional Data (JSON)</label>
                            <textarea class="form-control font-monospace" rows="2" @bind="Item.AdditionalData" placeholder='{"customField": "value"}'></textarea>
                            <div class="form-text">Use this field for any system-specific data not covered above.</div>
                        </div>

                        @if (!IsNew)
                        {
                            <hr />
                            <div class="row text-muted small">
                                <div class="col-md-6">
                                    <strong>Received At:</strong> @Item.ReceivedAt.ToString("MMM dd, yyyy h:mm tt")
                                </div>
                            </div>
                        }
                    </EditForm>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@_saving">
                    @Helpers.ConfirmButtonTextCancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="Save" disabled="@(_saving || _loading)">
                    @if (_saving) {
                        <i class="fa-solid fa-spinner fa-spin me-1"></i>
                        <span>Saving...</span>
                    } else {
                        <i class="fa-solid fa-save me-1"></i>
                        <span>Save</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public DataObjects.AccessEvent Item { get; set; } = new();
    [Parameter] public EventCallback<DataObjects.AccessEvent> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private List<DataObjects.SourceSystem> _sourcesystemList = new();
    private bool IsNew => Item.AccessEventId == default;
    private bool _loading = true;
    private bool _saving = false;

    protected override async Task OnInitializedAsync() {
        var sourcesystemResult = await Helpers.GetOrPost<DataObjects.SourceSystemFilterResult>(
            DataObjects.Endpoints.FreeGLBA.GetSourceSystems, new DataObjects.SourceSystemFilter { PageSize = 1000 }) ?? new();
        _sourcesystemList = sourcesystemResult.Records;
        _loading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loading)
        {
            await Helpers.DelayedFocus("edit-accessevent-SourceSystemId");
        }
    }

    protected override void OnParametersSet()
    {
        // Set defaults for new records
        if (IsNew)
        {
            Item.AccessedAt = DateTime.Now;
        }
    }

    private async Task Save()
    {
        // Validation
        var errors = new List<string>();
        var focus = "";

        if (Item.SourceSystemId == Guid.Empty)
        {
            errors.Add(Helpers.MissingRequiredField("Source System"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-SourceSystemId";
        }
        if (string.IsNullOrWhiteSpace(Item.UserId))
        {
            errors.Add(Helpers.MissingRequiredField("User ID"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-UserId";
        }
        if (string.IsNullOrWhiteSpace(Item.SubjectId))
        {
            errors.Add(Helpers.MissingRequiredField("Subject ID"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-SubjectId";
        }
        if (string.IsNullOrWhiteSpace(Item.AccessType))
        {
            errors.Add(Helpers.MissingRequiredField("Access Type"));
            if (string.IsNullOrEmpty(focus)) focus = "edit-accessevent-AccessType";
        }

        if (errors.Any())
        {
            Model.ErrorMessages(errors);
            await Helpers.DelayedFocus(focus);
            return;
        }

        _saving = true;
        Model.Message_Saving();
        StateHasChanged();

        try
        {
            await OnSave.InvokeAsync(Item);
            Model.ClearMessages();
            Model.Message_Saved();
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        if (!_saving)
        {
            await OnCancel.InvokeAsync();
        }
    }
}
